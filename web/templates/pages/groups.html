{{ define "group_management" }}
{{ template "partials/header" . }}
<div
    class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
    x-data="groupManagement()"
    x-init="fetchGroups()"
>
    <div class="py-10">
        <h1 class="text-2xl font-semibold text-foreground">Groups Management</h1>
    </div>

    <!-- Search and Add Group Section -->
    <div class="flex justify-between items-center mb-6">
        <input
            type="text"
            x-model="state.searchQuery"
            @input.debounce.500ms="fetchGroups()"
            placeholder="Search groups..."
            class="input input-bordered w-full max-w-lg"
        />
        <button
            @click="openAddGroupModal()"
            class="ml-4 btn btn-primary"
        >
            Add Group
        </button>
    </div>

    <!-- Groups Table -->
    <div class="mt-8 overflow-x-auto">
        <table class="table table-zebra w-full">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Users</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="group in state.groups" :key="group.id">
                    <tr>
                        <td x-text="group.name"></td>
                        <td x-text="group.description || 'No description'"></td>
                        <td>
                            <span x-text="group.users.length + (group.users.length === 1 ? ' user' : ' users')"></span>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-outline btn-info mr-2" @click="editGroup(group.id)">Edit</button>
                            <button class="btn btn-xs btn-outline btn-error" @click="deleteGroup(group.id)">Delete</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="state.groups.length === 0">
                    <td colspan="4" class="text-center">No groups found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="flex justify-center mt-4" x-show="state.pageCount > 1">
        <div class="join">
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === 1}"
                @click="goToPage(state.page - 1)"
                :disabled="state.page === 1"
            >Prev</button>
            <template x-for="p in state.pageCount" :key="p">
                <button class="join-item btn btn-sm"
                    :class="{'btn-active': p === state.page}"
                    @click="goToPage(p)"
                    x-text="p"
                ></button>
            </template>
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === state.pageCount}"
                @click="goToPage(state.page + 1)"
                :disabled="state.page === state.pageCount"
            >Next</button>
        </div>
    </div>

    <!-- Group Modal (reused for both add and edit) -->
    <div class="modal" :class="{'modal-open': modals.group}">
        <div class="modal-box w-full max-w-lg">
            <h3 class="font-bold text-lg mb-4" x-text="modals.mode === 'add' ? 'Add Group' : 'Edit Group'"></h3>
            <form @submit.prevent="submitGroup">
                <div class="mb-4">
                    <label class="block mb-1 font-medium">Name</label>
                    <input type="text" class="input input-bordered w-full" x-model="forms.group.name" required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium">Description</label>
                    <input type="text" class="input input-bordered w-full" x-model="forms.group.description" />
                </div>
                <div class="modal-action">
                    <button type="button" class="btn" @click="closeGroupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" x-text="modals.mode === 'add' ? 'Add' : 'Update'"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function groupManagement() {
        return {
            // State management
            state: {
                groups: [],
                searchQuery: "",
                page: 1,
                count: 10,
                pageCount: 1,
                totalCount: 0,
                loading: false,
                users: [],
                usersPage: 1,
                usersPageCount: 1,
                usersLoading: false
            },

            // Modal states
            modals: {
                group: false,
                mode: 'add',
                currentGroupId: null
            },

            // Form states
            forms: {
                group: {
                    name: "",
                    description: "",
                    selectedUsers: [],
                    userSearch: ""
                }
            },

            // Methods
            fetchGroups() {
                this.state.loading = true;
                let url = `/api/v1/groups?page=${this.state.page}&count_per_page=${this.state.count}`;
                if (this.state.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.state.searchQuery)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        this.state.groups = data.groups || [];
                        this.state.pageCount = data.page_count || 1;
                        this.state.totalCount = data.total_count || 0;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch groups");
                        this.state.groups = [];
                        this.state.pageCount = 1;
                    })
                    .finally(() => {
                        this.state.loading = false;
                    });
            },

            fetchUsers(page = 1) {
                this.state.usersPage = page;
                this.state.usersLoading = true;

                let url = `/api/v1/users?page=${this.state.usersPage}&count_per_page=${this.state.count}`;
                if (this.forms.group.userSearch) {
                    url += `&filter=${encodeURIComponent(this.forms.group.userSearch)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        this.state.users = data.users || [];
                        this.state.usersPageCount = data.page_count || 1;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch users");
                        this.state.users = [];
                        this.state.usersPageCount = 1;
                    })
                    .finally(() => {
                        this.state.usersLoading = false;
                    });
            },

            getGroup(id) {
                return fetch(`/api/v1/groups/${id}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to fetch group");
                        return res.json();
                    });
            },

            editGroup(id) {
                this.modals.mode = 'edit';
                this.modals.currentGroupId = id;
                this.modals.group = true;
                
                this.getGroup(id)
                    .then(group => {
                        this.forms.group = {
                            name: group.name,
                            description: group.description
                        };
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to load group details");
                        this.closeGroupModal();
                    });
            },

            openAddGroupModal() {
                this.modals.mode = 'add';
                this.modals.currentGroupId = null;
                this.forms.group = {
                    name: "",
                    description: ""
                };
                this.modals.group = true;
            },

            closeGroupModal() {
                this.modals.group = false;
            },

            submitGroup() {
                const payload = {
                    name: this.forms.group.name,
                    description: this.forms.group.description
                };

                const url = this.modals.mode === 'add'
                    ? '/api/v1/groups'
                    : `/api/v1/groups/${this.modals.currentGroupId}`;

                const method = this.modals.mode === 'add' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to ${this.modals.mode} group`);
                    return res.json();
                })
                .then(() => {
                    this.closeGroupModal();
                    this.fetchGroups();
                    this.notifySuccess(`Group ${this.modals.mode === 'add' ? 'added' : 'updated'} successfully`);
                })
                .catch(err => {
                    this.notifyError(err.message || `Failed to ${this.modals.mode} group`);
                });
            },

            goToPage(p) {
                if (p < 1 || p > this.state.pageCount) return;
                this.state.page = p;
                this.fetchGroups();
            },

            deleteGroup(id) {
                if (confirm("Are you sure you want to delete this group?")) {
                    fetch(`/api/v1/groups/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to delete group");
                    })
                    .then(() => {
                        this.fetchGroups();
                        this.notifySuccess("Group deleted successfully");
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to delete group");
                    });
                }
            },

            // Notification methods
            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>
{{ template "partials/footer" . }}
{{ end }}
